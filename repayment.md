# Repayment API's

1. When the lender returns an offer, a list of repayment plans should be provided which include the details about the schedule/when the repayments can be made.
2. The Borrower chooses a repayment plan upon which setRepaymentPlanRequest is called. The lender returns a payment page url as part of the response to setRepaymentPlan. This url will be loaded by the LSP inside the app which would show the kinds of payment methods that the lender supports for the chosen repayment plan.
3. The Borrower can choose a method on the payment page provided by the lender. In case of BHIM for lending, this will be a one-time e-mandate which the borrower can initiate by entering his vpa details. Post this, the lender will trigger a request to the PSP associated with the vpa for getting the authorization from the borrower. Post successful authorization, e-mandate becomes active and the repayment plan is also considered to be ACTIVE.
4. When the repayment is to be initiated, by an option other than e-mandate(not for BHIM for Lending), the user will be taken to the payment page from where he can choose a payment method and make the payment.


 ## Flow Diagram
 ![alt text](https://github.com/EzyReach/api-doc/blob/repayment-api/repayment.png "Repayment API")
 
## 1) Get Repayment Plans Request
   HTTP Verb - POST
   API Endpoint - /v3/repayment/getRepaymentPlansRequest

   This API is used to get the list of repayment plans provided by the lender for a particular loan.
   
  ### Request payload
  
   
   |Key               |Type    |Validations |Mandatory |Origin      |Description|
   |------------------|:------:|:----------:|:--------:|:----------:|----------:|
   |metadata          |Metadata|            |Yes       |LSP|Metadata specific to each API request.|
   |loanId |String |Ids are of length 35 each|Yes|Lender|UUID for Loan. Generated by Lender|
   |requestId|Alphanumeric|Length 35|Yes|LSP|UUID used to tie request and response and for idempotency.|
   
   
   ## Sample Request Json
   ```
   {
   "metadata": {
       "version": "1.0",
       "timestamp": "2018-12-06T11:39:57.153Z",
       "traceId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
       "orgId": "LSP123"
   },
   "requestId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
   "loanId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb"
}
```

  ### metadata

|Key      |Type  |Origin|Description|mandatory?|
|---------|:----:|:-----:|:-------|---------:|
|version  |String  |LSP    ||Y|
|timestamp|DateTime|LSP|This is the time at which consent handle request is created|Y|
|traceId  |String|LSP||Y|
|orgId    |String|LSP|This is the identification of the LSP|Y|

  ## Response payload
   
   |Key               |Type    |Validations |Mandatory |Description|
   |----|:----:|:----------:|:--------:|----------:|
   |ack |ACK   |            |Yes       |Acknowledgement block indicating the receipt and status of request|


  ## ACK Model
   
   |Key         |Type |Origin|comments|mandatory?|
|----------------|:---:|:----:|:------:|---------:|
|error           |String|Lender||Y|
|traceId         |String|LSP|The traceId in respone is the same as the traceId sent via request payload except the first character|Y|
|timestamp       |dateTime|Lender||Y|
   
  

## Sample Response Json
```
{
  "ack": {
    "error": "0",
    "traceId": "h8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
    "timestamp": "2020-12-01T11:39:57.153Z"
  }
}
```

## 2) Get Repayment Plans Response
HTTP Verb - POST
API Endpoint - /v3/repayment/getRepaymentPlansResponse

This API is invoked by the lender to the LSP returning the list of Repayment plans available for a particular loan.

### Request payload
  
   
   |Key               |Type    |Validations |Mandatory |Origin      |Description|
   |------------------|:------:|:----------:|:--------:|:----------:|----------:|
   |metadata          |Metadata|            |Yes       |LSP|Metadata specific to each API request.|
   |requestId|Alphanumeric|Length 35|Yes|LSP|UUID used to tie request and response and for idempotency.|
   |response |Response ||Yes|Lender|Response indicating whether error occurred|
   |plans |List<PaymentPlan> ||Yes|Lender|Repayment Plans for the loan|
  
  ## Sample Request Json
```
{
   "metadata": {
       "version": "1.0",
       "timestamp": "2018-12-06T11:39:57.153Z",
       "traceId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
       "orgId": "LSP123"
   },
   "response": {
       "error": "0"
   },
   "requestId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
   "plans": [
       {
           "id": "a8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
           "automatic": false,
           "scheduleType": "ONE_TIME",
           "payNowAllowed": false,
           "changeMethodAllowed": false,
           "noOfInstallments": "1",
           "totalAmount": "10000.00",
           "title": "Title of the repayment plan",
           "shortDescription": "short description of repayment plan",
           "url": "lender url showing repayment details"
       },
       {
           "id": "hb8c6822bd4bbb4eb1b9e1b4996fbff8acb",
           "automatic": false,
           "scheduleType": "ONE_TIME",
           "payNowAllowed": false,
           "changeMethodAllowed": false,
           "noOfInstallments": "1",
           "totalAmount": "10000.00",          
           "title": "Title of the repayment plan",
           "shortDescription": "short description of repayment plan",
           "url": "lender url showing repayment details"
       }
   ]
}
```

  
   ## Response payload
   
   |Key               |Type    |Validations |Mandatory |Description|
   |----|:----:|:----------:|:--------:|----------:|
   |ack |ACK   |            |Yes       |Acknowledgement block indicating the receipt and status of request|


  ## ACK Model
   
   |Key         |Type |Origin|comments|mandatory?|
|----------------|:---:|:----:|:------:|---------:|
|error           |String|Lender||Y|
|traceId         |String|LSP|The traceId in respone is the same as the traceId sent via request payload except the first character|Y|
|timestamp       |dateTime|Lender||Y|

## Sample Response Json
```
{
  "ack": {
    "error": "0",
    "traceId": "h8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
    "timestamp": "2020-12-01T11:39:57.153Z"
  }
}
```


## 3) Set Repayment Plan Request
   HTTP Verb - POST
   API Endpoint - /v3/repayment/setRepaymentPlanRequest

   This API is invoked by the LSP to inform the lender system about the details of the repayment plan that will be used by the borrower. The LSP will need to send either the LoanId or the LoanApplicationId as the case might be.
   
   ### Request payload
  
   
   |Key               |Type    |Validations |Mandatory |Origin      |Description|
   |------------------|:------:|:----------:|:--------:|:----------:|----------:|
   |metadata          |Metadata|            |Yes       |LSP|Metadata specific to each API request.|
   |loanApplicationId |String |Ids are of length 35 each|No|LSP|UUID for the loan application. Generated by LSP. This has to be there only if the request is made before grant loan is called.|
   |loanId |String |Ids are of length 35 each|NO|Lender|UUID for the loan. Generated by Lender. This will only be there if the repayment is created after the Grant Loan api call.|
   |requestId|Alphanumeric|Length 35|Yes|LSP|UUID used to tie request and response and for idempotency.|
   |plan|PaymentPlan||Yes|Lender|Repayment plan chosen by the borrower for the loan.|
   
   ### Sample Request Json
   ```
   {
   "metadata": {
       "version": "1.0",
       "timestamp": "2018-12-06T11:39:57.153Z",
       "traceId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
       "orgId": "LSP123"
   },
   "loanApplicationId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
   "requestId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
   "plan": {
      "id": "z8cc6822bd4bbb4eb1b9e1b4996fbff8acb"
   }
}
   ```
   
  ## Response payload
   
   |Key               |Type    |Validations |Mandatory |Description|
   |----|:----:|:----------:|:--------:|----------:|
   |ack |ACK   |            |Yes       |Acknowledgement block indicating the receipt and status of request|


  ## ACK Model
   
   |Key         |Type |Origin|comments|mandatory?|
|----------------|:---:|:----:|:------:|---------:|
|error           |String|Lender||Y|
|traceId         |String|LSP|The traceId in respone is the same as the traceId sent via request payload except the first character|Y|
|timestamp       |dateTime|Lender||Y|
   
   ## Sample Response Json
```
{
  "ack": {
    "error": "0",
    "traceId": "h8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
    "timestamp": "2020-12-01T11:39:57.153Z"
  }
}
```

## 4) Set Repayment Plan Response

HTTP Verb - POST
API Endpoint - /v3/repayment/setRepaymentPlanResponse

This API is invoked by the lender to the LSP giving the payment url where he can enter details of repayment.

### Request payload
  
   
   |Key               |Type    |Validations |Mandatory |Origin      |Description|
   |------------------|:------:|:----------:|:--------:|:----------:|----------:|
   |metadata          |Metadata|            |Yes       |LSP|Metadata specific to each API request.|
   |requestId|Alphanumeric|Length 35|Yes|LSP|UUID used to tie request and response and for idempotency.|
   |response |Response ||Yes|Lender|Response indicating whether error occurred|
   |plans |PaymentPlan ||Yes|Lender|Details of the chosen repayment plan|
   
 ### Sample Request Json
 ```
 {
   "metadata": {
       "version": "1.0",
       "timestamp": "2018-12-06T11:39:57.153Z",
       "traceId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
       "orgId": "LSP123"
   },
   "response": {
       "error": "0"
   },
   "requestId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
   "plan": {
           "id": "z8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
        "paymentUrl": "https://abcbank.in/z8cc6822bd4bbb4eb1b9e1b4996fbff8acb"
           "status": "PENDING_AUTH",
           "automatic": false,
           "payNowAllowed" : false,
           "changeMethodAllowed" : false,
           "scheduleType": "ONE_TIME",
           "noOfInstallments" : "1",
           "totalAmount": "10000.00"
       }
   }
}
 ```
 
## 5) Set Repayment Plan Status Request
HTTP Verb - POST
API Endpoint - /v3/repayment/setRepaymentPlanStatusRequest

This API is used by LSP to check the status of a previously initiated set repayment plan request. This API is called once the payment page of the lender is loaded and the borrower choses a repayment method associated with the chosen repayment plan.

 ### Request payload
  
   
   |Key               |Type    |Validations |Mandatory |Origin      |Description|
   |------------------|:------:|:----------:|:--------:|:----------:|----------:|
   |metadata          |Metadata|            |Yes       |LSP|Metadata specific to each API request.|
   |requestId|Alphanumeric|Length 35|Yes|LSP|UUID used to tie request and response and for idempotency.|
   |plan|PaymentPlan||Yes|Lender|Repayment plan chosen by the borrower for the loan.|

### Sample Request Json
```
{
   "metadata": {
       "version": "1.0",
       "timestamp": "2018-12-06T11:39:57.153Z",
       "traceId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
       "orgId": "LSP123"
   }
   "requestId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8aca",
   "plan": {
      "id": "z8cc6822bd4bbb4eb1b9e1b4996fbff8acb"
   }
}
```

## 6) Set Repayment Plan Status Response / Webhook
HTTP Verb - POST
API Endpoint - /v3/repayment/setRepaymentPlanStatusResponse

This API is used by lenders to inform LSP about the status of a previously initiated set Repayment.The API returns the status of the repayment plan that the borrower has chosen. In case, the borrower has chosen e-mandate as the repayment method in payment page url, the status of the repayment plan becomes ACTIVE only after successful authorization of the e-mandate on the PSP by the borrower.


   ### Request payload
  
   
   |Key               |Type    |Validations |Mandatory |Origin      |Description|
   |------------------|:------:|:----------:|:--------:|:----------:|----------:|
   |metadata          |Metadata|            |Yes       |LSP|Metadata specific to each API request.|
   |loanId |String |Ids are of length 35 each|NO|Lender|UUID for the loan. Generated by Lender.|
   |requestId|Alphanumeric|Length 35|No|LSP|UUID used to tie request and response and for idempotency.|
   |plan|PaymentPlan||Yes|Lender|Repayment plan chosen by the borrower for the loan.|
   |response |Response ||No|Lender|Response indicating whether error occurred.|
   
   ### Sample Request Json
   
   ```
   {
   "metadata": {
       "version": "1.0",
       "timestamp": "2018-12-06T11:39:57.153Z",
       "traceId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
       "orgId": "LSP123"
   },
   "response": {
       "error": "0"
   },
   "requestId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
   "plan": {
           "id": "a8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
           "automatic": false,
           "scheduleType": "ONE_TIME",
           "payNowAllowed" : false,
           "changeMethodAllowed" : false,
           "noOfInstallments" : "1",
           "totalmount": "10000.00",
           "status": "ACTIVE"
   }
}
   ```




  
  
   
