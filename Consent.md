# Consent APIs

## Flow Diagram
![alt text](https://github.com/EzyReach/api-doc/blob/consent-api/Consent%20Flow%20Diagram.PNG "Consent API")

  


# 1.Consent Handle Request
   HTTP Verb - POST
   ## API Endpoint - /v3/consent/consentHandleRequest

   This API is used to request the lenders to send a consent request for fetching the bank account statements, GST historical data. The lender (FIU) checks with the AA and     creates a consent handle internally once this API is triggered
   
   ## Model Mapping   
   ![alt text](https://github.com/EzyReach/api-doc/blob/consent-api/Consent_Model_Mapping.png "Consent API")

   ## Request Payload

   |Key               |Type    |Validations |Mandatory |Origin      |Description|
   |------------------|:------:|:----------:|:--------:|:----------:|----------:|
   |metadata          |Metadata|            |Yes       |LSP|Metadata specific to each API response.|
   |loanApplicationIds|Array Alphanumeric |Ids are of length 35 each|Yes|LSP|UUID for the loan applications,Generated by LSP.These are the list of loan Applications for which borrower wants consents to be created.|
   |requestId|Alphanumeric|Length 35|Yes|LSP|UUID used to tie request and response and for idempotency.|
   |consent|Consent||Yes|LSP|This includes the consent details needed for the loan.|
   
   
   
   ## Sample Request Json
   
   ``` {
   "metadata": {
       "version": "1.0",
       "timestamp": "2020-12-01T11:39:57.153Z",
       "traceId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
       "orgId": "LSP123"
   },
   "loanApplicationIds": [
       "f8cc6822bd4bbb4eb1b9e1b4996fbff8acb"
   ],
   "requestId": "g8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
   "consent": {
       "consentFetchType": "ONETIME",
       "vua": "user@aa.in",
       "isAggregationEnabled": true,
       "consentAggregationId": "e8cc6822bd4bbb4eb1b9e1b4996fbff8acd",
       "lspInfo": {
           "lspId": "<AA can identify the LSP based on this>",
           "version": "<version of LSP>",
           "appName": "<Package name of the app>"
       }
   }
} 
```
## Questions
   ```
    1.How consent will be mapped each application id.? With the current representation all loan applications of same user will have one consent request and consent handle(received it from lender as part of the consent request)?
    2.What would be the criteria to link the multiple loan applications of same user with one consent request.?
    3.Why lsp information is linked to consent , but not to the consent request.?(May be the same consent object will be used when lender starts comunicating with AA)
    4.How user will get to know to which lender he/she is giving the consent when the consent sent to multiple lenders.(may be this would be the scope of AA).
    5.source for the isAggregationEnabled and consentAggregationId fields are Unknown.
   ```
   
   ### metadata

|Key      |Type  |Origin|Description|mandatory?|
|---------|:----:|:-----:|:-------|---------:|
|version  |String  |LSP    ||Y|
|timestamp|DateTime|LSP|This is the time at which consent handle request is created|Y|
|traceId  |String|LSP||Y|
|orgId    |String|LSP|This is the identification of the LSP|Y|

 ### Consent

|Key                 |Type        |Origin |mandatory?|Description|
|--------------------|:----------:|:-----:|:-------|---------:|
|consentFetchType    |ENUM        |LSP    |Y|For ConsentHandleRequest this field value would be ONETIME and For ConsentMonitoring This value would be PERIODIC|
|vua|String|USER|Y|Account Aggregator id of the user|
|isAggregationEnabled|BOOLEAN|UNKNOWN|Y||
|consentAggregationId|String|UNKNOWN|Y||
|lsp|LSP Object|LSP|Y||
|consentHandle|String|Lender|Y|This will be provided by lender along with consent handle response|
|consentStatus|String|Lender|Y|This will be provided by lender along with consent status response. Possible values are READY,PENDING,FAILED | 
|URL|String|AA|Y|Once the user has given consent to AA,then AA will ping back the lender with the URL to get the user documents.|
|extensibleData|JSON OBJECT|LSP|N|Incase if any lender specific data or additional data  required in future we can accommodate in this object without disturbing the original structure|


   
   ### loan application id

|Key                 |Type        |Origin |Description|mandatory?|
|--------------------|:----------:|:-----:|:-------|---------:|
|loanApplicationIds  |List<String>|LSP    |applicationid which was generated during loan creation|Y|
  
   ## Response payload
   
   |Key               |Type    |Validations |Mandatory |Description|
   |----|:----:|:----------:|:--------:|----------:|
   |ack |ACK   |            |Yes       |Acknowledgement block indicating the receipt and status of request|
   
   ## ACK Model
   
   |Key         |Type |Origin|comments|mandatory?|
|----------------|:---:|:----:|:------:|---------:|
|error           |String|Lender||Y|
|traceId         |String|LSP|The traceId in respone is the same as the traceId sent via request payload except the first character|Y|
|timestamp       |dateTime|Lender||Y|
   
  

## Sample Response Json
```
{
  "ack": {
    "error": "0",
    "traceId": "h8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
    "timestamp": "2020-12-01T11:39:57.153Z"
  }
}
```

# 2.Consent Handle Response
  HTTP Verb - POST
  ## API Endpoint - /v3/consent/consentHandleResponse

 This API is invoked by the lenders to send the consent handles created in the AA system as part of the Consent Handle Request API triggered by the LSP.
 
 ## Request Payload

   |Key               |Type    |Validations |Mandatory |Origin      |Description|
   |------------------|:------:|:----------:|:--------:|:----------:|----------:|
   |metadata          |Metadata|            |Yes       |Lender|Metadata specific to each API response.|
   |response          |Response ||Yes|Lender|Status of response. Whether success or has encountered error|
   |requestId|Alphanumeric|Length 35|Yes|Lender|UUID used to tie request and response and for idempotency.|
   |consent|Consent||Yes|Lender|Consent details shared back by the lender.|

  ## Sample Request Json
  ```
  {
   "metadata": {
       "version": "1.0",
       "timestamp": "2018-12-06T11:39:57.153Z",
       "traceId": "h8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
       "orgId": "FIU123"
   },
   "response": {
       "error": "0"
   },
   "requestId": "i8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
   "consent": {
       "consentHandle": "j8cc6822bd4bbb4eb1b9e1b4996fbff8acb"
   }
}
  ```
# 3.Consent Status Request
   HTTP Verb - POST
   ## API Endpoint - /v3/consent/consentStatusReques
   
   This API is invoked by the LSP to check the status of Consents.
   
   ## Request Payload

   |Key               |Type    |Validations |Mandatory |Description|
   |------------------|:------:|:----------:|:--------:|----------:|
   |metadata          |Metadata|            |Yes       |Metadata specific to each API response.|
   |requestId|Alphanumeric|Length 35|Yes|UUID used to tie request and response and for idempotency.|
   |consent|Consent||Yes|This includes the consent details needed for the loan.Mainly consent handle field shuould be passed which was provided by the lender as part of the Consent Handle Response|
   
   ## Response payload
   
   |Key               |Type    |Validations |Mandatory |Description|
   |----|:----:|:----------:|:--------:|----------:|
   |ack |ACK   |            |Yes       |Acknowledgement block indicating the receipt and status of request|



## Sample Request Json
   
   ``` {
   "metadata": {
       "version": "1.0",
       "timestamp": "2020-12-01T11:39:57.153Z",
       "traceId": "l8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
       "orgId": "LSP123"
   },
   "requestId": "m8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
   "consent": {
       "consentHandle": "m8cc6822bd4bbb4eb1b9e1b4996fbff8acb"
   }
} 
```

## Sample Response Json
```
{
  "ack": {
    "error": "0",
    "traceId": "n8cc6822bd4bbb4eb1b9e1b4996fbff8acb",
    "timestamp": "2020-12-01T11:39:57.153Z"
  }
}
```


# 4. Consent Status Response
   HTTP Verb - POST
   ## API Endpoint - /v3/consent/consentStatusResponse

This API is invoked by the lender as a response informing the LSP regarding the status of the consents.

## Non Functional Requirements
|API|SLA(seconds)|Timeout (seconds)|Throughput|
|---|------------|-----------------|----------|
|consentHandleRequest - consentHandleResponse|<2|4|100 Tps|
|consentStatusRequest - consentStatusResponse|<2|4|100 Tps|

# 5 ConsentHandleRequest And ConsentStatusRequest For Monitoring

 These API's are same as above. Once the Repayment was setup successfully ,LSP is going request or enable the regular consent monitoring,which will happen through Lender.This time ConsentFetchType value would be Periodic. 
